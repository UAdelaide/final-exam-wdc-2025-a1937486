<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | Dog Owner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-light">
  <div id="dashboard" class="container py-4">
    <header class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="text-primary">Owner Panel</h2>
      <div>
        <span class="me-3">Logged in as <strong>{{ state.ownerName }}</strong></span>
        <button type="button" @click="exit" class="btn btn-outline-secondary btn-sm">Log Out</button>
      </div>
    </header>

    <!-- Form: New walk -->
    <section class="card mb-4">
      <div class="card-header bg-success text-white">
        Schedule a Walk
      </div>
      <div class="card-body">
        <form @submit.prevent="createWalk">
          <div class="mb-3">
            <label class="form-label">Dog</label>
            <select v-model="state.walkForm.dog_id" class="form-select" required>
              <option value="">-- Select dog --</option>
              <option v-for="dog in state.myDogs" :value="dog.dog_id">{{ dog.name }} ({{ dog.size }})</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Time</label>
            <input type="datetime-local" v-model="state.walkForm.requested_time" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Duration</label>
            <input type="number" v-model="state.walkForm.duration_minutes" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Place</label>
            <input type="text" v-model="state.walkForm.location" class="form-control" required>
          </div>
          <button class="btn btn-primary" type="submit">Submit</button>
        </form>
      </div>
    </section>

    <!-- Feedback -->
    <div v-if="state.feedback" class="alert alert-success">{{ state.feedback }}</div>
    <div v-if="state.failure" class="alert alert-danger">{{ state.failure }}</div>

    <!-- List: existing requests -->
    <h4 class="mb-3">Your Walk History</h4>
    <div v-if="state.history.length > 0" class="row">
      <div class="col-md-6 mb-3" v-for="item in state.history" :key="item.request_id">
        <div class="card">
          <div class="card-body">
            <h6 class="card-title">Walk #{{ item.request_id }}</h6>
            <p class="card-text">
              üê∂ <strong>{{ item.dog_name }}</strong> ({{ item.size }})<br>
              üìÖ {{ new Date(item.requested_time).toLocaleString() }}<br>
              ‚è±Ô∏è {{ item.duration_minutes }} mins<br>
              üìç {{ item.location }}<br>
              üìä Status: {{ item.status }}
            </p>
          </div>
        </div>
      </div>
    </div>
    <p v-else class="text-muted">No walk records yet.</p>
  </div>

  <script>
    const { createApp, reactive } = Vue;

    createApp({
      setup() {
        const state = reactive({
          walkForm: {
            dog_id: '',
            requested_time: '',
            duration_minutes: '',
            location: ''
          },
          myDogs: [],
          history: [],
          feedback: '',
          failure: '',
          ownerName: ''
        });

        const exit = async () => {
          try {
            await fetch('/logout', { method: 'POST' });
          } finally {
            window.location.href = '/';
          }
        };

        const fetchUser = async () => {
          const res = await fetch('/api/auth/check');
          if (!res.ok) return location.href = '/';
          const data = await res.json();
          if (data.role !== 'owner') {
            window.location.href = data.role === 'walker' ? '/walker-dashboard.html' : '/';
          }
          state.ownerName = data.username;
        };

        const fetchWalks = async () => {
          try {
            const res = await fetch('/api/walks');
            state.history = await res.json();
          } catch {
            state.failure = 'Unable to fetch walk history.';
          }
        };

        const fetchDogs = async () => {
          try {
            const res = await fetch('/api/dogs');
            state.myDogs = await res.json();
          } catch {
            state.failure = 'Unable to load dog list.';
          }
        };

        const createWalk = async () => {
          state.feedback = '';
          state.failure = '';
          try {
            const res = await fetch('/api/walks', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(state.walkForm)
            });
            const result = await res.json();
            if (!res.ok) throw new Error(result.error || 'Request failed.');
            state.feedback = result.message || 'Walk created.';
            Object.assign(state.walkForm, {
              dog_id: '', requested_time: '', duration_minutes: '', location: ''
            });
            fetchWalks();
          } catch (err) {
            state.failure = err.message;
          }
        };

        // Init
        fetchUser().then(() => {
          fetchDogs();
          fetchWalks();
        });

        return { state, createWalk, exit };
      }
    }).mount('#dashboard');
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
